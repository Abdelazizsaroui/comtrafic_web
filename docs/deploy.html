<!DOCTYPE html>
<html>
<head>
	<title>Comtrafic</title>
</head>
<style>
	body {
		padding-left: 20%;
		padding-right: 20%;
		padding-bottom: 50px;
	}
	code {
		font-weight: 600;
	}
</style>
<body>
	<h1>Guide de déploiement de l'interface web de ComTrafic</h1>
	<hr>
	<p>Ce guide présente les étapes pour le déploiement de l'interface web de ComTrafic sur 3 environnements différents.</p>
	<h2>I - Serveur Linux sur une IaaS:</h2>
	<p>Cette partie concerne le déploiement sur un serveur Linux sur une IaaS (Infrastructure as a Service). Dans une IaaS le fournisseur Cloud nous fournit juste une infrastructure et on doit tout configurer. Dans ce guide on a utilisé une machine virtuelle Linux Ubuntu 18.04 sur Microsoft Azure.</p>
	<p>Avant de procéder au dépoiement, il faut créer un utilisateur autre que <em>root</em> sur le serveur et avoir le port 80 ouvert (aussi le port 22 si on va se connecter au serveur via SSH). Le nom de l'utilisateur dans ce guide est repéré par UTILISATEUR.</p>
	<p>On va utiliser <em>NGINX</em> et <em>Gunicorn</em> pour servir le projet.</p>
	<p>Ce guide est indépendant du fournisseur Cloud qui héberge le serveur.</p>

	<h4>1 - Environnement virtuel de Python:</h4>
	Avant d'installer et configurer un environnement virtuel de Python, on doit d'abord vérifier que <em>Python 3.6+</em> et <em>Pip</em> sont installés.
	<p>On va utiliser <em>Venv</em> dans ce guide, on l'installe comme suit: <br> <center><code>sudo apt install python3-venv</code></center></p>
	<p>Dans le répertoire personnel <em>/home/UTILISATEUR</em> on crée un environnement virtuel avec le nom <em>env</em> avec la commande suivante: <br> <center><code>python3 -m venv env</code></center> <br> Puis on active <em>env</em> avec: <center><code>source env/bin/activate</code></center></p>

	<h4>2 - Installation du projet:</h4>
	<p>On récupère le projet depuis le dépot sur Gitlab: <br> <center><code>git clone https://gitlab.com/prost.phil/interface-web-pour-comtrafic</code></center></p>
	<p>On se déplace sur le répertoire <em>interface-web-pour-comtrafic</em>, puis on installe les dépendances du projet: <br> <center><code>pip3 install -r requirement.txt</code></center></p>

	<h4>3 - Configuration de NGINX:</h4>
	<p><em>NGINX</em> est un serveur web très populaire et open source, on va l'utiliser pour traiter les requêtes et servir les fichiers statiques pour l'interface. On l'installe comme suit: <br> <center><code>sudo apt install nginx</code></center></p>
	<p>On supprime le fichier de configuration par défaut de <em>NGINX</em>: <br> <center><code>sudo rm /etc/nginx/sites-enabled/default</code></center></p>
	<p>Puis on crée et ouvre un fichier de configuration pour le projet: <br> <center><code>sudo nano /etc/nginx/sites-enabled/comtrafic</code></center></p>
	<p>On enregistre sur le fichier la configuration suivante:</p>
	<div style="border: 1px solid gray; font-family: monospace; padding: 10px;">
		server {<br>
		    listen 80;<br>
		    server_name IP_OU_NOM_DE_DOMAINE;<br>
		    <br>
		    location /static {<br>
		        alias /home/UTILISATEUR/interface-web-pour-comtrafic/comtrafic_web/static;<br>
		    }<br>
		    <br>
		    location / 	{<br>
		        proxy_pass http://localhost:8000;<br>
		        include /etc/nginx/proxy_params;<br>
		        proxy_redirect off;<br>
		    }<br>
		}
	</div>
	<p>Il faut remplacer IP_OU_NOM_DE_DOMAINE par l'IP du serveur ou son nom de domaine.</p>
	<p>Puis on redémarre le serveur <em>NGINX</em> pour prendre les changements faits en considération: <br> <center><code>sudo systemctl restart nginx</code></center></p>

	<h4>4 - Gunicorn et Supervisor:</h4>
	<p><em>NGINX</em> permet de traiter les requêtes web et servir les fichiers statiques, mais il ne permet pas de communiquer avec le code Python du projet. Pour cela on va utiliser <em>Gunicorn</em>, il a été déjà installé avec les dépendances.</p>
	<p>On lance <em>Gunicorn</em> avec la commande: <br> <center><code>gunicorn -w 3 run:app</code></center></p>
	<p>Le nombre 3 est pour une machine avec un seul coeur, il est préférable de remplacer le nombre 3 selon la machine avec (2 * NOMBRE_DE_COEURS) + 1 <br> Pour savoir le nombre de coeurs du CPU de la machine, on exécute la commande: <br> <center><code>nproc --all</code></center></p>
	<p>A cet étape, et sans fermer la console où <em>Gunicorn</em> est lancé, l'interface doit marcher sans problème si on visite l'IP du serveur ou son nom de domaine.</p>
	<p>Une dernière chose qui reste à fixer, c'est que si on arrête la console dont réside le processus <em>Gunicorn</em> ou la machine a été redémarré ou une erreur survient on perd l'application. Pour régler ça on va utiliser <em>Supervisor</em>, on l'installe comme suit: <br> <center><code>sudo apt install supervisor</code></center></p>
	<p>On crée et ouvre le fichier de configuration de <em>Supervisor</em>: <br> <center><code>sudo nano /etc/supervisor/conf.d/comtrafic.conf</code></center></p>
	<p>On enregistre la configuration suivante dans le fichier:</p>
	<div style="border: 1px solid gray; font-family: monospace; padding: 10px;">
		[program:comtrafic] <br>
		directory=/home/UTILISATEUR/interface-web-pour-comtrafic <br>
		command=/home/UTILISATEUR/env/bin/gunicorn -w 3 run:app <br>
		user=UTILISATEUR <br>
		autostart=true <br>
		autorestart=true <br>
		stopasgroup=true <br>
		killasgroup=true <br>
	</div>
	<p>Puis on redémarre <em>Supervisor</em>: <br> <center><code>sudo supervisorctl reload</code></center></p>
	<p>Et comme ça l'application doit marcher même si on ferme la console ou redémarre la machine.</p>
	<br>

	<h2>II - Serveur Linux sur une PaaS:</h2>
	<p>Le déploiement sur une PaaS (Plateform as a Service) ne demande pas beaucoup d'efforts car la majorité des configurations sont faites par le fournisseur Cloud, mais en contrepartie il offre moins de flexibilité et de contrôle. Dans ce guide on a déployé l'interface sur <em>Heroku</em>.</p>
	<p>Tout d'abord, il faut avoir un compte sur <em>Heroku</em>, puis on crée une nouvelle application pour le projet. On peut choisir de déployer le code depuis le dépot du projet sur <em>Github</em> ou utiliser <em>Heroku Git</em> (via <em>Heroku CLI</em>).</p>
	<p>Les configurations nécessaires sont déjà inclut avec le projet. <em>Procfile</em> déclare l'entrée de l'application pour le serveur web, cela nécessite <em>Gunicorn</em> qui est aussi inclut dans le fichier des dépendances <em>requirements.txt</em> qui est installé automatiquement lorsqu'on charge le code sur <em>Heroku</em>.</p>
	<p>On peut choisir le déploiment automatique de l'application en liant son dépot sur <em>Github</em> avec <em>Heroku</em>, tel que à chaque fois qu'on pousse le code sur <em>Github</em> une nouvelle version de l'application est déployée.</p>

	<h2>III - Serveur Windows:</h2>
	<small>A ajouter ..</small>

</body>
</html>